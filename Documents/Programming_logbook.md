# Programming logbook

### 07/05/2020
#### Main Simulation
The goal of today will be to create a good mesh for our problem. 
I found an interesting forum [discussion](https://www.cfd-online.com/Forums/openfoam-meshing/88973-simple-sphere-snappyhexmesh.html) about meshing spheres in openFoam.
Post #7 seems promising to me, he shares 2 different snappyHexMesh files (a meshing utility in openFoam to alter simple blockmeshes) and a blockmesh file.
I will first just coppy these files in the case, run them by first using the blockMesh command and then the snappyHexMesh command.
Then I will look at the meshes created in paraView and adjust from there.

![snappyHexMeshDictSphere](https://user-images.githubusercontent.com/64592913/81285483-e5357480-905f-11ea-9191-4e8c030712b7.png)

This is the mesh generated by the snappyHexMeshDictSphere file in the previously described forum post. 
It looks like a good starting point but lets double check the mesh generated by the other snappyHexMeshDict file in the forum post.

![snappyHexMeshDictCavity](https://user-images.githubusercontent.com/64592913/81286536-7f49ec80-9061-11ea-94db-64cf8323d295.png)

This is the mesh generated by the snappyHexMeshDictcavity file. This is further away from our goal mesh so I'll use the snappyHexMeshDictSphere file as starting point.

#### Salt concentration 
I coppied the NernstPlanck ICEO tutorial case file over and named it saltConcentration. I'll start by changing the blockmesh file located in constant/polymesh to a 1D case.  Only 8 vertices and 1 block is needed to define this geometry, I'll start with simplegrading (1 1 1) of the block can be later refined if needed. Changing the boundary condition to 1D by making the sides also empty, and defining the correct patches for the electrodes. Keep in mind that the order in which you state the vertices for the blocks and boundary conditions has to follow certain rules described in the openFoam userguide section 5.3. Lets inspect the created mesh in paraview. 

![saltConcentrationMesh](https://user-images.githubusercontent.com/64592913/81297779-128c1d80-9074-11ea-9557-8616da09045c.png)

This looks like the right 1D mesh so lets continue with the other files. lets start with the 0 directory, we need to change all the boundary condition names to match the ones we just defined in the blockMeshDict file I'll mention if I change the condition itself. in the cAnion and cCation files the boundary conditions at the electrodes must be changed from fixed values, I think zeroIonicFlux will be a good boundary condition to use here. There is a value entry for this B.C. I hope this doesn't fix the value in time otherwise I'll have to change this B.C.. In the psi file I changed the value of the  elecNorth to 0.025V and changed the value of the electSouth to 0V. 

Nothing needs to be changed in the constant directory for now, in the electricProperties file we can change the charge/diffusivity of the ions. Changing the charge and diffusivity of the ions will be needed to reproduce results. 

### 08/05/2020
#### salt concentration
I will use the sample tool provided by openFoam, this lets me read out the ion concentrations allong a line. The sampleDict file is in the system directory. I took out the psi and u from the fields to be sampled because we are only interested in the ion concentrations. I changed the type to uniform and the axis to Z, I added nPoints since this is needed with a uniform line and i put it to 50 and i changed the start and end points to match our geometry. I deleted the probes function out of the controlDict file and the jMonitor and ciMonitor functions from the fvSolution file since the sample utility will be all we need for our purpose. 

Now I think everything is ready so lets run it by first entering "blockMesh" and then "rheoEFoam" in the terminal. 

[this](https://www.cfd.at/sites/default/files/tutorialsV4/14-ExampleFourteen.pdf) tutorial explains how to incorperate the sample function while the simulation is running, that might be interesting to explore at a later time.

### 11/05/2020
#### salt concentration
The simulation took 20 hours to simulate 0.15 seconds on my laptop, I think it an definetly be refined to run quicker. Some thing to look into are taking out the Navier-Stokes equations, bigger delta t timesteps, smaller simulation time if the data converges to a value quicker then after 0.15 seconds. 

Before going into the refinement lets first look if the simulation actually did what we would expect. by running the "sample" command in the case directorie a new directorie gets created named sets wherin the ion concentrations of different times are stored in .xy files. We first have to convert these files to .txt files to import them to python (I didn't find a way to input the .xy files directly but maybe that's also possible) I'll save the converted files in the new Data folder in this repository.

I imported the data to python and put it in different graphs for each timestep. As can be seen from these graphs the ionic concentrations converge within 0.03 seconds to their end values since from that point onward there is no more change in the graphs, this means that letting the simulation run until 0.03s will be suficient. I didn't expect to see a linear relation between the ion concentrations and the distance from the electrode because of shielding from the EDL, so I think something went wrong.
![saltConcentration_firstRun](https://user-images.githubusercontent.com/64592913/81566078-a3c40280-939a-11ea-9f7e-853e114eb62b.png)

### 12-05-2020
#### salt concentration
Last night I run the simulation while turning of the Navier-Stokes equations in the fvSolution file in the system case directory to check if the results would be the same. This time the simulation finished in 4.5 hours so it took a lot shorter time to simulate the 0.15 seconds. The results look exactly the same so for our purpose I keep the Navier-Stokes equations turned off during future runs
![saltConcentration_secondRun](https://user-images.githubusercontent.com/64592913/81671989-d2e57d00-9449-11ea-82ee-ea0c2b30d705.png)

I upped the starting ion concentrations by 3 orders of magnitude to see if the correlation between the distance of the electrode and the ion concentration changes. The ion concentration is controlled in the 0/cAnion and 0/cCation files in the case directory. I kept the run time at 0.15 seconds because I don't know if the equilibrium time changes with starting ion concentration.

### 13-05-2020
#### salt concentration
The same linear correlation exists in the simulation with higher starting ion concentrations. 
![saltConcentration_highC](https://user-images.githubusercontent.com/64592913/81787076-d2f48400-9500-11ea-91d2-ca8b720e20a5.png)

For the next run I'll make the length of the simulation domain 2 orders of magnitude bigger. I'll also let the simulation run untill 0.09 seconds instead of 0.15, I will drop the starting concentration of ions back down so I can isolate the effect of a bigger domain. Making the length bigger is done in the blockMeshDict file in constant/polymesh, I'll also have to change the sampleDict file in the system directorie to sample the new points. The run time can be changed in the controlDict file in the system directorie.

Still the exact same linear behaviour is produced, this is a unfysical result because the concentration at 10e-7 meter from the electrode shouldn't be the same as the concentration 10e-9 meter from the electrode, which is the case currently comparing these results to the results of the second run.
![saltConcentration_bigDomain](https://user-images.githubusercontent.com/64592913/81807660-c4b56080-951e-11ea-910b-17171091141f.png)

Since I kept getting the same linear correlation between the ion concentration and distance from electrode, which I still think is wrong. I'm gonna try to break this linear correlation by going for an even bigger simulation domain (order of magnitude in cm) taking the same high ionic concentration as in the highC run, and refining the mesh. If this will still produce the linear correlation then either something in the simulation isn't working correctly or my understanding of the problem is wrong. 

While refining the mesh in the blockMeshDict file I noticed something was wrong. In the blocks subdict you first define the shape of the block, the next entry is which vertices the block consists of and the entry after that decides how much cells are in each direction. The entry was set at ( 80 80 1 ), meaning there were 80 cells in the x and y directions and only 1 cell in the Z direction. The z direction was the only direction that the script was solving for so I changed the entry to ( 1 1 100 ) which should hopefully solve the issues. I decided to rerun the previous bigDomain run but this time with the correct mesh. Finally something else then a linear correlation showed up in the data. What was also interesting is that the simulation time got cut down from 4.5hours to half a minute.
![saltConventration_bigDomainFixed](https://user-images.githubusercontent.com/64592913/81917094-07d20b00-95d5-11ea-9419-e931fd9dbee9.png)

### 14-05-2020
#### saltConcentration
I decided to turn the Navier-Stokes equations on again, since simulation time is not an issue anymore. I simulated the original domain with the original variables used in the first run. 
![saltConcentration_originalDomainFixed](https://user-images.githubusercontent.com/64592913/81916144-bb3a0000-95d3-11ea-88db-89faccf1dda0.png)

I'm gonna do a simulation with the concentration of ions in milimol per liter, this equals 1 mol per kubic meter which are the units that openFoam works with. I'm gonna make the simulation domain 30 debyelengths long, this concentration corresponds to an debye length of 9.74 nanometer, I will make the simulation domain 290 nanometer long. I should set the simulation time at atleast 10*L^2/D which equals 8.41e-4 seconds, I will let it run untill 0.03 seconds then the simulation wil definetly have reached equilibrium. 

### 15-05-2020
#### saltConcentration
I will refine the mesh by putting simple grading on ( 1 1 10 ) what this does is make the cell closest to the neutral electrode 10 times as long as the cell closest to the charged electrode, as can be seen on the picture below. This is important because we want a refined mesh at the EDL position and we don't care as much about the mesh far away from the EDL. 
![saltConcentrationMesh](https://user-images.githubusercontent.com/64592913/82044931-851d7e80-96ae-11ea-8c3b-70e0f97c676a.png)

### 18-05-2020
#### saltConcentration
The simulation got a lot less stable because of the increased salt concentration, I had to increase the delta t from 2e-5 to 2e-8 to keep it from crashing. Interesting in these results is the drop to 0 potential next to the opposite electrode, this comes from the boundary condition that fixes the potential at 0 here. I feel like this result is unphysical and I should try and switch this boundary condition.
![saktConcentration_1mM](https://user-images.githubusercontent.com/64592913/82200415-3f0b2980-98ff-11ea-9214-fdaca81e0126.png)

### 20-05-2020
#### saltconcentration_timeDep
So apparently I forgot to save the changes I made to the logbook yesterday. I found a [boundary condition](https://openfoamwiki.net/index.php/Main_ContribExamples/OscillatingFixedValue) that could be used for the ACpotential. I put the frequency at 100 so one cycle would take 0.01 seconds. I changed the runtime to 0.01 seconds, the writeinterval to 0.0025 seconds so I would get samples at the extreme values of the function and at the points where the potential was 0. I had to half the delta t timestep to 1e-8 for the simulation to not crash. 

Looking at the results, it looks like the potential stayed fixed at 1V and the ion concentrations are acting weird. I need to find a different boundary condition for the ACpotential.
![saltConcentration_timeDep_firstRun](https://user-images.githubusercontent.com/64592913/82427509-7efe1800-9a89-11ea-8f5c-58fedf105b8d.png)

### 01-06-2020
#### saltconcentration
I will refine the mesh further by making it finer at both electrodes and more spread out in the midle. This can be done by making 2 blocks instead of 1 and do the simplegrading in reverse for both blocks. The mesh now looks lik this:
![saltConcentrationMesh](https://user-images.githubusercontent.com/64592913/83436287-e0d16100-a43d-11ea-83ef-75b2707178e3.png)

I want to study the time scale of the formation of the EDL, a good time scale to look at is multiples of 1/(k^2*D) which represents the time it takes for ions to diffuse 1 debye length. For these simulation parameters that corresponds to 9.49e-8 seconds. at the controlDict file I put the end time as 100 times this quantity. the writeinterval as 0.1 times this quantity and I will put the delta t as 2e-10. I will also change the potential at the other electrode to -25mV to get a symmetric graph. This will also get the potential to drop to 0 between the electrodes what is needed to fit my derived theorethical potential because of a B.C. during the derivation.

I noticed that at 100 times this debye diffusion time I could not tell yet if the system had equilibrated, the potential profile was slightly different then at 50 times the diffusion time. I let the simulation continue running untill 250 times the diffusion time which had the same potential profile at 100 times the diffusion time. This tells us that the system equilibrated somewhere between 50 and 100 times this diffusion time.

### 08-06-2020
#### saltConcentration
Today I will repeat the last experiment but then with a dimensionless potential of 4, this equals a potential of 103.4mV in our simulation. It took longer for the system to equilibriate, the simulation can be continued from the point that it finished at by altering the controlDict file as is further explainen in the openFoam user guide section 4.4 time and data input/output control.

### 12-06-2020
#### saltConcentration_timeDep
I want to find out how many discrete timepoints are needed to sample the rms E field in the center of the 2 electrodes over 1 AC cycle. I'll pick the cycle length to be 50 Debye diffusion times and the voltage amplitude to be 25mV, this way the cycle is shorter then the systems equilibriation time so the EDL's will not fully form. to reach this cycle length the frequency in the BC of the electrode in the 0/psi file should be put at 1/(50*9.49e-8) = 210748.156 s^-1. lets sample 100 discrete times in this cycle to see how many are needed for the rms E value in the center to converge to a certain value, so the sample time should be put at 4.745e-8. 

### 19-06-2020
#### saltconcentration_timeDep
After processing the data in a python script the output was:
the root mean square of 10 timesteps = 49989.8441357484, 
the root mean square of 25 timesteps = 49349.01167597555,
the root mean square of 50 timesteps = 49176.4578207401,
the root mean square of 100 timesteps = 49098.060019631856,
as can be seen in the data folder. It looks like this data is converging to a value just below 49kV for the true rms value of the electric field. Since we are taking discrete timesteps the more timesteps we will use the better it reflects the true value. At the same time an equivalent circuit was studied, and a theorethical formula was derived for the rms electric field. filling in the parameters used in the simulation gave a theorethical value of 54.3kV/m, which is pretty close to the simulated values. I'm going to let the simulation run for 3 extra cycles to see if the simulated value gets closer to the theorethical one, it can take some cycles for the system to get to its steady state response. continuing the simulation can be done bychanging the starttime in the controlDict file to latestTime.


